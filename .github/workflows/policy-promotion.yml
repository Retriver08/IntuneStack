name: üî• IntuneStack - Policy Promotion

on:
    # Automatic triggers
    push:
        branches: [main, development]
        paths:
            - "src/PolicyPromotion.ps1"
            - "tests/PolicyPromotion.Tests.ps1"
            - ".github/workflows/policy-promotion.yml"

    pull_request:
        branches: [main, development]
        paths:
            - "src/PolicyPromotion.ps1"
            - "tests/**"
            - ".github/workflows/policy-promotion.yml"

    # Manual dispatch with options
    workflow_dispatch:
        inputs:
            policy_id:
                description: "Policy ID (GUID) to test"
                required: true
                type: string

            current_stage:
                description: "Current deployment stage"
                required: true
                default: "dev"
                type: choice
                options:
                    - dev
                    - test
                    - prod

            compliance_threshold:
                description: "Success rate threshold (%)"
                required: false
                default: "80"
                type: string

            auto_promote:
                description: "Enable auto-promotion"
                required: false
                default: false
                type: boolean

            output_level:
                description: "Output verbosity"
                required: false
                default: "Normal"
                type: choice
                options:
                    - Minimal
                    - Normal
                    - Detailed

            run_tests_only:
                description: "Run Pester tests only (skip live testing)"
                required: false
                default: false
                type: boolean

# Scheduled testing (optional - runs daily at 6 AM UTC)
#  schedule:
#  - cron: '0 6 * * 1-5'  # Weekdays only

env:
    # PowerShell preferences
    POWERSHELL_TELEMETRY_OPTOUT: 1
    REPORTS_PATH: "./output/reports"
    ARTIFACTS_PATH: "./output/artifacts"

# Required permissions for OIDC and Graph API
permissions:
    id-token: write
    contents: read
    pull-requests: write
    actions: read

jobs:
    # Job 1: Code Quality and Static Analysis
    code-quality:
        name: üîç Code Quality & Static Analysis
        runs-on: ubuntu-latest

        steps:
            - name: üì• Checkout Repository
              uses: actions/checkout@v4

            - name: üì¶ Install Required Modules
              shell: pwsh
              run: |
                  # Suppress progress bars for clean output
                  $ProgressPreference = 'SilentlyContinue'

                  # Install PSScriptAnalyzer if not available
                  if (-not (Get-Module -ListAvailable -Name PSScriptAnalyzer)) {
                    Write-Host "Installing PSScriptAnalyzer..."
                    Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser
                  }

                  $pesterModule = Get-Module -ListAvailable -Name Pester | Where-Object { $_.Version -ge [Version]'5.0' }
                  if (-not $pesterModule) {
                    Install-Module -Name Pester -Force -Scope CurrentUser -MinimumVersion 5.0 -AllowClobber
                  }

                  Write-Host "‚úìModules ready" -ForegroundColor Green

            - name: üîç Run PSScriptAnalyzer
              shell: pwsh
              run: |
                  New-Item -Path "output" -ItemType Directory -Force | Out-Null

                   $results = Invoke-ScriptAnalyzer -Path "./src/PolicyPromotion.ps1" -Severity Error,Warning -ExcludeRule @(
                     'PSAvoidUsingWriteHost',
                     'PSAvoidOverwritingBuiltInCmdlets',
                     'PSAvoidUsingConvertToSecureStringWithPlainText'
                   ) -Recurse

                   if ($results) {
                     $results | Format-Table RuleName, Severity, Line, Message -AutoSize
                     $results | Export-Csv -Path "./output/scriptanalyzer-results.csv" -NoTypeInformation

                     $errors = $results | Where-Object Severity -eq 'Error'
                     if ($errors) {
                       Write-Host "‚úó Found $($errors.Count) error(s)" -ForegroundColor Red
                       exit 1
                     }

                     $warnings = $results | Where-Object Severity -eq 'Warning'
                     Write-Host "‚ö† Found $($warnings.Count) warning(s)" -ForegroundColor Yellow
                   } else {
                     Write-Host "‚úì No issues found"
                   }

            - name: üìä Upload Code Quality Results
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: code-quality-results
                  path: |
                      output/scriptanalyzer-results.csv
                  retention-days: 30
                  if-no-files-found: ignore

    # Job 2: Unit Testing with Pester
    unit-tests:
        name: üß™ Unit Tests (Pester)
        runs-on: ubuntu-latest
        needs: code-quality

        steps:
            - name: üì• Checkout Repository
              uses: actions/checkout@v4

            - name: üì¶ Install Testing Modules
              shell: pwsh
              run: |
                  $ProgressPreference = 'SilentlyContinue'

                  $pesterModule = Get-Module -ListAvailable -Name Pester | Where-Object { $_.Version -ge [Version]'5.0' }
                  if (-not $pesterModule) {
                     Write-Host "Installing Pester..."
                     Install-Module -Name Pester -Force -Scope CurrentUser -MinimumVersion 5.0 -AllowClobber
                   }

                  if (-not (Get-Module -ListAvailable -Name Microsoft.Graph.Authentication)) {
                     Write-Host "Installing Microsoft.Graph.Authentication..."
                     Install-Module -Name Microsoft.Graph.Authentication -Force -Scope CurrentUser
                   }

                   Write-Host "‚úì Modules ready"

            - name: üß™ Run Pester Tests
              shell: pwsh
              run: |
                  New-Item -Path "output/test-results" -ItemType Directory -Force | Out-Null

                  # Configure Pester
                  $pesterConfig = New-PesterConfiguration
                  $pesterConfig.Run.Path = "./tests/PolicyPromotion.Tests.ps1"
                  $pesterConfig.TestResult.Enabled = $true
                  $pesterConfig.TestResult.OutputPath = "./output/test-results/PolicyPromotion-TestResults.xml"
                  $pesterConfig.TestResult.OutputFormat = "NUnitXml"
                  $pesterConfig.CodeCoverage.Enabled = $true
                  $pesterConfig.CodeCoverage.Path = "./src/PolicyPromotion.ps1"
                  $pesterConfig.CodeCoverage.OutputPath = "./output/test-results/PolicyPromotion-Coverage.xml"
                  $pesterConfig.Output.Verbosity = "Detailed"

                  # Run tests
                  $testResults = Invoke-Pester -Configuration $pesterConfig

                  # Output summary
                  Write-Host "`n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
                  Write-Host "Total:   $($testResults.TotalCount)"
                  Write-Host "Passed:  $($testResults.PassedCount)" -ForegroundColor Green
                  Write-Host "Failed:  $($testResults.FailedCount)" -ForegroundColor $(if($testResults.FailedCount -gt 0){'Red'}else{'Green'})
                  Write-Host "Skipped: $($testResults.SkippedCount)" -ForegroundColor Yellow
                  Write-Host "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

                  if ($testResults.FailedCount -gt 0) {
                    exit 1
                  }

            - name: üìä Upload Test Results
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: test-results
                  path: |
                      output/test-results/
                  retention-days: 30

    # Job 3: Integration Testing
    integration-tests:
        name: üîó Integration Tests (Graph API)
        runs-on: ubuntu-latest
        needs: [code-quality, unit-tests]
        if: github.event_name == 'workflow_dispatch' && !inputs.run_tests_only

        environment:
            name: development
            url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

        steps:
            - name: üì• Checkout Repository
              uses: actions/checkout@v4

            - name: Request OIDC token from GitHub
              id: oidc
              shell: bash
              run: |
                  OIDC_TOKEN="$(curl -s -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
                    "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=api://AzureADTokenExchange" | jq -r .value)"
                  echo "oidc_token=$OIDC_TOKEN" >> $GITHUB_OUTPUT

            - name: Debug token length
              shell: pwsh
              run: |
                  $token = "${{ steps.oidc.outputs.oidc_token }}"
                  Write-Host "OIDC token length: $($token.Length)"

            - name: üì¶ Install Graph Modules
              shell: pwsh
              run: |
                  $ProgressPreference = 'SilentlyContinue'

                  # Install Microsoft Graph Authentication if not available
                  if (-not (Get-Module -ListAvailable -Name Microsoft.Graph.Authentication)) {
                    Write-Host "Installing Microsoft.Graph.Authentication..."
                    Install-Module -Name Microsoft.Graph.Authentication -Force -Scope CurrentUser
                  }

                  Write-Host "‚úì Modules ready"

            - name: üß™ Execute Policy Promotion Script
              shell: pwsh
              env:
                  POLICY_ID: ${{ inputs.policy_id }}
                  CURRENT_STAGE: ${{ inputs.current_stage }}
                  COMPLIANCE_THRESHOLD: ${{ inputs.compliance_threshold || '80' }}
                  AUTO_PROMOTE: ${{ inputs.auto_promote || 'false' }}
                  OUTPUT_LEVEL: ${{ inputs.output_level || 'Normal' }}
                  # Authentication environment variables
                  AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
                  AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
                  OIDC_TOKEN: ${{ steps.oidc.outputs.oidc_token }}
                  # Optional: Pass custom group names only if defined as repository variables
                  INTUNESTACK_DEV_GROUP: ${{ vars.INTUNESTACK_DEV_GROUP }}
                  INTUNESTACK_TEST_GROUP: ${{ vars.INTUNESTACK_TEST_GROUP }}
                  INTUNESTACK_PROD_GROUP: ${{ vars.INTUNESTACK_PROD_GROUP }}
              run: |
                  # Validate required inputs
                  if (-not $env:POLICY_ID) {
                     Write-Host "‚ùå Policy ID is required but not provided" -ForegroundColor Red
                     exit 1
                  }

                  if (-not $env:CURRENT_STAGE) {
                     Write-Host "‚ùå Current stage is required but not provided" -ForegroundColor Red
                     exit 1
                  }

                  # Create output directories
                  New-Item -Path "$env:REPORTS_PATH" -ItemType Directory -Force | Out-Null
                  New-Item -Path "$env:ARTIFACTS_PATH" -ItemType Directory -Force | Out-Null
                  # Build parameters
                  $params = @{
                    PolicyId = $env:POLICY_ID
                    ComplianceThreshold = [int]$env:COMPLIANCE_THRESHOLD
                    CurrentStage = $env:CURRENT_STAGE
                    OutputPath = $env:REPORTS_PATH
                    OutputLevel = $env:OUTPUT_LEVEL
                  }
                  if ($env:AUTO_PROMOTE -eq 'true') {
                    $params.AutoPromote = $true
                  }
                  # Execute script
                  try {
                    & "./src/PolicyPromotion.ps1" @params
                    $exitCode = $LASTEXITCODE
                    if ($exitCode -eq 0) {
                      Write-Host "`n‚úì Ready for promotion" -ForegroundColor Green
                    } else {
                      Write-Host "`n‚è≥ Not ready for promotion (exit code: $exitCode)" -ForegroundColor Yellow
                    }
                  }
                  catch {
                    Write-Host "`n‚úó Error: $($_.Exception.Message)" -ForegroundColor Red
                    exit 1
                  }

            - name: üìä Upload Results
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: integration-test-results
                  path: |
                      ${{ env.REPORTS_PATH }}/
                      ${{ env.ARTIFACTS_PATH }}/
                  retention-days: 30

            - name: üìù Summary
              if: always()
              shell: pwsh
              run: |
                  $summary = @"
                  # üî• IntuneStack Policy Promotion Results

                  ## Test Configuration
                  - **Policy ID**: ${{ inputs.policy_id }}
                  - **Current Stage**: ${{ inputs.current_stage }}
                  - **Compliance Threshold**: ${{ inputs.compliance_threshold || '80' }}%
                  - **Auto Promote**: ${{ inputs.auto_promote || 'false' }}
                  - **Output Level**: ${{ inputs.output_level || 'Normal' }}
                  - **Workflow**: ${{ github.workflow }}
                  - **Run ID**: ${{ github.run_id }}

                  ## Results
                  View details: [Actions run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}).
                  "@

                  $summary | Out-File -FilePath "$env:REPORTS_PATH/test-summary.md" -Encoding UTF8
                  $summary | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding UTF8

    # Job 4: Synthetic/Mock Testing (when no real environment available)
    mock-tests:
        name: üé≠ Mock/Synthetic Tests
        runs-on: ubuntu-latest
        needs: [code-quality, unit-tests]
        if: github.event_name != 'workflow_dispatch' || inputs.run_tests_only

        steps:
            - name: üì• Checkout Repository
              uses: actions/checkout@v4

            - name: Run Synthetic Tests
              shell: pwsh
              run: |
                  Write-Host "Running synthetic/mock tests..." -ForegroundColor Cyan

                  # Create mock output directory
                  New-Item -Path "$env:REPORTS_PATH" -ItemType Directory -Force | Out-Null


                  # Test script syntax
                  $testCases = @(
                    @{ PolicyId = ""; Stage = "dev"; Threshold = 80 }
                    @{ PolicyId = ""; Stage = "test"; Threshold = 85 }
                    @{ PolicyId = ""; Stage = "prod"; Threshold = 90 }
                  )

                  foreach ($test in $testCases) {
                    Write-Host "Testing: Stage=$($test.Stage), Threshold=$($test.Threshold)"
                  }

                  Write-Host "‚úì Synthetic tests passed"

            - name: üìä Upload Results
              uses: actions/upload-artifact@v4
              with:
                  name: mock-test-results
                  path: ${{ env.REPORTS_PATH }}/
                  retention-days: 30
                  if-no-files-found: ignore
